<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERRA-LINK: Ragdoll Saga</title>
    <!-- Подключаем движки из надежных источников -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #5aa2e2; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .panel { background: #5d4037; border: 4px solid #3d2a1f; color: #f7e692; padding: 15px; pointer-events: auto; box-shadow: 8px 8px 0 rgba(0,0,0,0.3); }
        
        /* Главное меню */
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; text-align: center; }
        .btn { background: #5ea74d; border: 3px solid #36612a; color: white; padding: 10px; width: 100%; margin: 5px 0; cursor: pointer; font-size: 10px; font-family: 'Press Start 2P'; }
        .btn:hover { background: #76c961; }
        input { width: 90%; padding: 10px; background: #000; border: 2px solid #f7e692; color: #fff; font-family: 'Press Start 2P'; font-size: 10px; margin: 10px 0; }

        /* Чат и SMS */
        #chat-box { position: absolute; bottom: 120px; left: 10px; width: 220px; height: 100px; background: rgba(0,0,0,0.6); display: none; flex-direction: column; font-size: 8px; color: #fff; padding: 5px; }
        #sms { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); background: #ffeb3b; padding: 10px; color: #000; transition: 0.5s; font-size: 10px; border: 3px solid #000; }

        /* Контроллеры */
        .joy-area { position: absolute; bottom: 20px; width: 100px; height: 100px; border: 2px dashed #fff; border-radius: 50%; pointer-events: auto; }
        #joy-l { left: 20px; } #joy-r { right: 20px; }
        .grab-btn { position: absolute; bottom: 130px; width: 60px; height: 60px; background: #ff4747; border: 3px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 8px; pointer-events: auto; }
        #btn-l { left: 40px; } #btn-r { right: 40px; }
        .active-grab { background: #47ff47 !important; }
    </style>
</head>
<body>

<div id="ui">
    <div id="menu" class="panel">
        <h2 style="font-size: 14px;">TERRA-LINK</h2>
        <div id="status">Инициализация...</div>
        <div id="my-id-label" style="margin: 10px 0; font-size: 8px; color: #fff;"></div>
        <input type="text" id="target-id" placeholder="ID ДРУГА">
        <button class="btn" onclick="connectToPeer()">ИГРАТЬ</button>
        <button class="btn" style="background:#4d70a7" onclick="copyInviteLink()">ССЫЛКА</button>
        <div style="font-size: 6px; margin-top: 15px;">КЛАН: [MINERS] | ОНЛАЙН: FREE</div>
    </div>

    <div id="sms">ПРИГЛАШЕНИЕ ПРИНЯТО!</div>
    <div id="chat-box" class="panel">
        <div id="messages" style="flex:1; overflow-y:auto;"></div>
        <input type="text" id="chat-in" placeholder="ЧАТ..." style="margin:0; width:95%; font-size:7px;">
    </div>

    <div id="joy-l" class="joy-area"></div>
    <div id="joy-r" class="joy-area"></div>
    <div id="btn-l" class="grab-btn">L-GRAB</div>
    <div id="btn-r" class="grab-btn">R-GRAB</div>
</div>

<script>
/** --- СЕТЕВАЯ ЧАСТЬ (БЕСПЛАТНОЕ ОБЛАКО PEERJS) --- **/
let peer, conn, myShortId, player, partner, scene;
let isHost = false;

function initNetwork() {
    // Используем стандартный сервер PeerJS (0.peerjs.com) - это бесплатно!
    myShortId = Math.floor(1000 + Math.random() * 9000).toString();
    peer = new Peer('terra-' + myShortId);

    peer.on('open', (id) => {
        document.getElementById('status').innerText = "ГОТОВ К ИГРЕ";
        document.getElementById('my-id-label').innerText = "ВАШ ID: " + myShortId;
        checkAutoJoin();
    });

    peer.on('connection', (c) => {
        conn = c; isHost = true; setupConn();
    });

    peer.on('error', (err) => {
        console.error(err);
        alert("Ошибка сети. Попробуйте обновить страницу.");
    });
}

function connectToPeer() {
    const tid = document.getElementById('target-id').value;
    if(!tid) return;
    conn = peer.connect('terra-' + tid);
    setupConn();
}

function setupConn() {
    conn.on('open', () => {
        showSms("СВЯЗЬ УСТАНОВЛЕНА!");
        document.getElementById('menu').style.display = 'none';
        document.getElementById('chat-box').style.display = 'flex';
        startGame();
    });
    conn.on('data', data => {
        if(data.type === 'sync') syncPartner(data.state);
        if(data.type === 'chat') addChat("ДРУГ", data.msg);
    });
}

function copyInviteLink() {
    const link = window.location.origin + window.location.pathname + "?join=" + myShortId;
    navigator.clipboard.writeText(link).then(() => showSms("ССЫЛКА СКОПИРОВАНА!"));
}

function checkAutoJoin() {
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('join');
    if(joinId) {
        document.getElementById('target-id').value = joinId;
        setTimeout(connectToPeer, 1000);
    }
}

/** --- ИГРОВАЯ ФИЗИКА (TERRARIA STYLE) --- **/
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'matter', matter: { gravity: { y: 1.2 }, debug: false } },
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    scene = this;
    const draw = (k, c, w, h) => {
        let g = this.make.graphics({x:0,y:0,add:false});
        g.fillStyle(c, 1); g.fillRect(0,0,w,h);
        g.lineStyle(2, 0x000000, 0.2); g.strokeRect(0,0,w,h);
        g.generateTexture(k, w, h);
    };
    draw('dirt', 0x5d4037, 40, 40);
    draw('grass', 0x388e3c, 40, 40);
    draw('p_body', 0xe0a96d, 20, 30);
    draw('p_arm', 0xe0a96d, 10, 10);
}

function create() {
    this.matter.world.setBounds(0, 0, 10000, 2000);
    initNetwork();
}

function createRagdoll(x, y) {
    const M = scene.matter;
    const group = M.world.nextGroup(true);

    const body = M.add.image(x, y, 'p_body').setRectangle(20, 30).setCollisionGroup(group).setFriction(0.5);
    const lHand = M.add.image(x-20, y, 'p_arm').setCircle(8).setCollisionGroup(group).setFriction(1);
    const rHand = M.add.image(x+20, y, 'p_arm').setCircle(8).setCollisionGroup(group).setFriction(1);

    const cL = M.add.constraint(body, lHand, 50, 0.1, {pointA:{x:-10, y:0}});
    const cR = M.add.constraint(body, rHand, 50, 0.1, {pointA:{x:10, y:0}});

    return { body, lHand, rHand, grabs: [null, null] };
}

function startGame() {
    // Генерация 50 уровней (просто длинный мир)
    for(let i=0; i<500; i++) {
        let tx = i * 40;
        let ty = 600 + Math.sin(i*0.2) * 80;
        scene.matter.add.image(tx, ty, 'grass', null, {isStatic:true});
        if(i % 10 === 0) { // Деревья для лазанья
            for(let j=1; j<8; j++) scene.matter.add.image(tx, ty - j*40, 'dirt', null, {isStatic:true});
        }
    }

    player = createRagdoll(200, 400);
    partner = createRagdoll(250, 400);
    partner.body.setTint(0xff8888);

    scene.cameras.main.startFollow(player.body, true, 0.1, 0.1);
    scene.cameras.main.setZoom(1.2);

    setupControls();
}

function setupControls() {
    const handleGrab = (side) => {
        const idx = side === 'L' ? 0 : 1;
        const hand = side === 'L' ? player.lHand : player.rHand;
        const btn = document.getElementById('btn-' + side.toLowerCase());

        if(player.grabs[idx]) {
            scene.matter.world.removeConstraint(player.grabs[idx]);
            player.grabs[idx] = null;
            btn.classList.remove('active-grab');
        } else {
            const bodies = scene.matter.world.localWorld.bodies;
            for(let b of bodies) {
                if(b === player.body.body || b === player.lHand.body || b === player.rHand.body) continue;
                if(Phaser.Math.Distance.Between(hand.x, hand.y, b.position.x, b.position.y) < 40) {
                    player.grabs[idx] = scene.matter.add.constraint(hand, b, 5, 0.8);
                    btn.classList.add('active-grab');
                    break;
                }
            }
        }
    };

    document.getElementById('btn-l').onclick = () => handleGrab('L');
    document.getElementById('btn-r').onclick = () => handleGrab('R');

    // Чат
    document.getElementById('chat-in').onkeydown = e => {
        if(e.key === 'Enter' && e.target.value) {
            addChat("Я", e.target.value);
            conn.send({type:'chat', msg: e.target.value});
            e.target.value = '';
        }
    };
}

function update() {
    if(!player || !conn) return;

    // Управление: руки летят за указателем
    if(this.input.activePointer.isDown) {
        const p = this.input.activePointer;
        const hand = p.worldX < player.body.x ? player.lHand : player.rHand;
        const force = 0.004;
        hand.applyForce({x: (p.worldX - hand.x) * force, y: (p.worldY - hand.y) * force});
    }

    // Синхронизация
    conn.send({
        type: 'sync',
        state: {
            bx: player.body.x, by: player.body.y, br: player.body.rotation,
            lx: player.lHand.x, ly: player.lHand.y,
            rx: player.rHand.x, ry: player.rHand.y
        }
    });
}

function syncPartner(s) {
    if(!partner) return;
    partner.body.setPosition(s.bx, s.by).setRotation(s.br);
    partner.lHand.setPosition(s.lx, s.ly);
    partner.rHand.setPosition(s.rx, s.ry);
}

function addChat(u, m) {
    const b = document.getElementById('messages');
    b.innerHTML += `<div>[${u}]: ${m}</div>`;
    b.scrollTop = b.scrollHeight;
}

function showSms(t) {
    const s = document.getElementById('sms');
    s.innerText = t; s.style.top = '20px';
    setTimeout(() => s.style.top = '-100px', 3000);
}
</script>
</body>
</html>
