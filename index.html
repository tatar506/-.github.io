<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TERRA CO-OP: REACH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --ui-gold: #ffce00;
            --terra-green: #5da341;
        }
        body, html { 
            margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%;
            background: #000; font-family: 'Press+Start+2P', cursive;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #game-container { width: 100vw; height: 100vh; }

        /* –û–≤–µ—Ä–ª–µ–π –º–µ–Ω—é */
        #menu-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #2c3e50, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–≤–æ—Ä–æ—Ç–µ —ç–∫—Ä–∞–Ω–∞ */
        #rotate-notice {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; text-align: center; padding: 20px;
        }

        .menu-title {
            color: var(--terra-green); font-size: clamp(16px, 5vw, 28px); text-align: center;
            text-shadow: 4px 4px #000; margin-bottom: 30px;
        }

        .characters-preview { display: flex; gap: 20px; margin-bottom: 20px; }
        .preview-box {
            width: 80px; height: 120px; border: 4px solid #555;
            background: rgba(0,0,0,0.5); position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .preview-box.empty { filter: brightness(0); opacity: 0.4; }
        .preview-label { position: absolute; top: -15px; font-size: 7px; color: #fff; width: 100%; text-align: center; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; width: 90%; max-width: 320px; }
        .btn {
            background: #4a6e35; border: 4px solid #2d4522; color: #fff;
            padding: 14px; cursor: pointer; font-family: 'Press+Start+2P';
            font-size: 10px; text-align: center; box-shadow: 0 4px 0 #1a2a14;
            transition: 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn.gold { background: #b08d00; border-color: #7a6200; box-shadow: 0 4px 0 #4d3d00; }

        /* HUD */
        .mobile-hud { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 100; }
        .grab-btn {
            position: absolute; bottom: 30px; width: 80px; height: 80px;
            border-radius: 50%; background: rgba(0,0,0,0.4);
            border: 4px solid #fff; pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #btn-l { left: 40px; }
        #btn-r { right: 40px; }
        .grab-btn.active { background: var(--ui-gold); border-color: #fff; color: #000; transform: scale(1.1); }
        
        #chat-trigger {
            position: absolute; top: 10px; left: 10px; pointer-events: auto;
            background: rgba(0,0,0,0.5); padding: 8px; border: 2px solid #fff; color: #fff; font-size: 7px;
        }
        
        #fs-toggle {
            position: absolute; top: 10px; right: 10px; pointer-events: auto;
            background: rgba(0,0,0,0.5); padding: 8px; border: 2px solid #fff; color: #fff; font-size: 7px;
        }

        #chat-wrapper {
            position: fixed; bottom: 120px; left: 20px; width: 250px;
            pointer-events: none; z-index: 500;
        }
        .message {
            background: rgba(0,0,0,0.7); color: #fff; padding: 6px;
            font-size: 8px; margin-bottom: 5px; border-left: 4px solid var(--ui-gold);
            animation: slideIn 0.3s;
        }

        #chat-input-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; width: 80%; pointer-events: auto; z-index: 1001;
        }
        #chat-input {
            width: 100%; background: #000; border: 4px solid var(--ui-gold);
            padding: 15px; color: #fff; font-family: 'Press+Start+2P'; font-size: 12px;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="rotate-notice">
        <p>–ü–û–ñ–ê–õ–£–ô–°–¢–ê,<br>–ü–ï–†–ï–í–ï–†–ù–ò–¢–ï –¢–ï–õ–ï–§–û–ù</p>
        <div style="font-size: 40px; margin-top: 20px;">üì±üîÑ</div>
    </div>

    <div id="menu-overlay">
        <h1 class="menu-title">TERRA CO-OP: REACH</h1>
        
        <div class="characters-preview">
            <div class="preview-box" id="p1-box">
                <div class="preview-label">–í–´</div>
                <canvas id="p1-canvas" width="60" height="90"></canvas>
            </div>
            <div id="connection-status" style="font-size: 20px;">ü§ù</div>
            <div class="preview-box empty" id="p2-box">
                <div class="preview-label">–î–†–£–ì</div>
                <canvas id="p2-canvas" width="60" height="90"></canvas>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn gold" id="start-game-btn">–ò–ì–†–ê–¢–¨ (FULLSCREEN)</button>
            <button class="btn" id="invite-btn" style="background: #34495e; border-color: #2c3e50;">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
            <p id="status" style="color: #aaa; font-size: 7px; text-align: center; line-height: 1.5;">
                –û–ñ–ò–î–ê–ù–ò–ï –î–†–£–ì–ê...<br>(ID: <span id="my-id">...</span>)
            </p>
        </div>
    </div>

    <div class="mobile-hud" id="hud">
        <div id="chat-trigger">–ß–ê–¢</div>
        <div id="fs-toggle">FS</div>
        <div id="btn-l" class="grab-btn">–õ–ï–í–ê–Ø</div>
        <div id="btn-r" class="grab-btn">–ü–†–ê–í–ê–Ø</div>
        <div id="chat-wrapper"></div>
        <div id="chat-input-box">
            <input type="text" id="chat-input" placeholder="–°–û–û–ë–©–ï–ù–ò–ï...">
        </div>
    </div>

    <div id="game-container"></div>

<script>
/**
 * –°–ò–°–¢–ï–ú–ê –§–£–õ–õ–°–ö–†–ò–ù–ê –ò –û–†–ò–ï–ù–¢–ê–¶–ò–ò
 */
async function enterFullscreen() {
    try {
        const doc = document.documentElement;
        if (doc.requestFullscreen) await doc.requestFullscreen();
        else if (doc.webkitRequestFullscreen) await doc.webkitRequestFullscreen();
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
        if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock('landscape').catch(e => console.log("Orientation lock failed"));
        }
    } catch (err) {
        console.warn("Fullscreen error:", err);
    }
}

function checkOrientation() {
    const notice = document.getElementById('rotate-notice');
    if (window.innerHeight > window.innerWidth) {
        notice.style.display = 'flex';
    } else {
        notice.style.display = 'none';
    }
}
window.addEventListener('resize', checkOrientation);
checkOrientation();

/**
 * –°–ï–¢–¨ (PEERJS)
 */
const myId = Math.floor(1000 + Math.random() * 9000).toString();
let peer, conn;

function initNetwork() {
    peer = new Peer('TERRA-REACH-' + myId);
    peer.on('open', () => {
        document.getElementById('my-id').innerText = myId;
        const hash = window.location.hash.replace('#', '');
        if (hash && hash.length === 4) {
            conn = peer.connect('TERRA-REACH-' + hash);
            setupConnection();
        }
    });
    peer.on('connection', c => {
        conn = c;
        setupConnection();
        startOnlineGame();
    });
}

function setupConnection() {
    conn.on('open', () => {
        startOnlineGame();
        conn.on('data', data => {
            if (data.type === 'sync') window.gameScene?.syncRemote(data.payload);
            if (data.type === 'chat') showChatMessage(data.msg, 'friend');
        });
    });
}

document.getElementById('invite-btn').onclick = () => {
    const url = window.location.origin + window.location.pathname + '#' + myId;
    navigator.clipboard.writeText(url);
    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –µ—ë –¥—Ä—É–≥—É.");
};

document.getElementById('start-game-btn').onclick = async () => {
    await enterFullscreen();
    if (conn && conn.open) {
        startOnlineGame();
    } else {
        alert("–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥—Ä—É–≥–∞ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É —Å—Å—ã–ª–∫—É!");
    }
};

document.getElementById('fs-toggle').onclick = enterFullscreen;

function showChatMessage(msg, sender) {
    const wrap = document.getElementById('chat-wrapper');
    const el = document.createElement('div');
    el.className = 'message';
    el.innerText = (sender === 'me' ? '–í–´: ' : '–î–†–£–ì: ') + msg;
    wrap.prepend(el);
    setTimeout(() => el.remove(), 5000);
}

/**
 * –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (PHASER)
 */
class GameScene extends Phaser.Scene {
    constructor() { super('GameScene'); }

    create() {
        window.gameScene = this;
        this.matter.world.setBounds(0, -1000, 5000, 2000);
        
        // –¢–µ–∫—Å—Ç—É—Ä—ã
        const dirt = this.add.renderTexture(0, 0, 32, 32).fill(0x6d4c35);
        for(let i=0; i<20; i++) dirt.draw(this.add.rectangle(Math.random()*32, Math.random()*32, 2, 2, 0x5a3d2a));
        dirt.saveTexture('dirt');

        this.p1 = this.createRagdoll(200, 400, 0x5da341, false);
        this.p2 = this.createRagdoll(240, 400, 0x3498db, true);
        
        this.setupMap();
        this.setupCamera();
    }

    createRagdoll(x, y, color, isRemote) {
        const group = this.matter.world.nextGroup(true);
        const b = this.matter.add.rectangle(x, y, 22, 32, { collisionFilter: { group }, friction: 0.6 });
        const h = this.matter.add.circle(x, y - 25, 10, { collisionFilter: { group } });
        const la = this.matter.add.circle(x - 20, y, 8, { collisionFilter: { group }, friction: 1 });
        const ra = this.matter.add.circle(x + 20, y, 8, { collisionFilter: { group }, friction: 1 });

        this.matter.add.constraint(b, h, 0, 0.8, { pointA: {x:0, y:-16}, pointB: {x:0, y:10} });
        this.matter.add.constraint(b, la, 40, 0.1, { pointA: {x:-10, y:-8} });
        this.matter.add.constraint(b, ra, 40, 0.1, { pointA: {x:10, y:-8} });

        return { body: b, head: h, lHand: la, rHand: ra, color, grabL: false, grabR: false, isRemote, g: this.add.graphics() };
    }

    setupMap() {
        const addBlock = (x, y, w, h) => {
            let b = this.add.tileSprite(x, y, w, h, 'dirt').setOrigin(0.5);
            this.matter.add.gameObject(b, { isStatic: true });
        };
        addBlock(400, 600, 1000, 100);
        addBlock(900, 450, 100, 300);
        
        this.goal = this.add.star(1200, 400, 5, 20, 40, 0xffff00);
        this.matter.add.gameObject(this.goal, { isStatic: true, isSensor: true });
    }

    setupCamera() {
        this.cameras.main.startFollow(this.p1.body, true, 0.1, 0.1);
        this.cameras.main.setZoom(1.3);
        this.cameras.main.setBackgroundColor('#80a5ff');
    }

    update() {
        this.handleInput();
        this.syncP2P();
        [this.p1, this.p2].forEach(p => {
            this.processGrab(p);
            this.drawRagdoll(p);
        });
    }

    handleInput() {
        const p = this.p1;
        this.input.pointers.forEach(ptr => {
            if(ptr.isDown && ptr.y < window.innerHeight - 100) {
                const hand = ptr.x < window.innerWidth / 2 ? p.lHand : p.rHand;
                this.matter.applyForce(hand, { x: (ptr.x - ptr.downX) * 0.00015, y: (ptr.y - ptr.downY) * 0.00015 });
            }
        });
    }

    processGrab(p) {
        [{h: p.lHand, g: p.grabL, k: 'cL'}, {h: p.rHand, g: p.grabR, k: 'cR'}].forEach(s => {
            if (s.g && !p[s.k]) {
                const targets = this.matter.world.localWorld.bodies.filter(b => b !== s.h && b !== p.body);
                const hit = targets.find(t => Phaser.Math.Distance.Between(s.h.position.x, s.h.position.y, t.position.x, t.position.y) < 25);
                if (hit) p[s.k] = this.matter.add.constraint(s.h, hit, 0, 1);
            } else if (!s.g && p[s.k]) {
                this.matter.world.removeConstraint(p[s.k]);
                p[s.k] = null;
            }
        });
    }

    drawRagdoll(p) {
        const g = p.g; g.clear();
        const skin = p.isRemote ? 0xd1c4e9 : 0xffdbac;
        g.fillStyle(skin); g.fillCircle(p.head.position.x, p.head.position.y, 10);
        g.fillStyle(p.color);
        g.save(); g.translateCanvas(p.body.position.x, p.body.position.y); g.rotate(p.body.angle);
        g.fillRect(-11, -16, 22, 32); g.restore();
        g.lineStyle(5, skin);
        g.lineBetween(p.body.position.x, p.body.position.y - 8, p.lHand.position.x, p.lHand.position.y);
        g.lineBetween(p.body.position.x, p.body.position.y - 8, p.rHand.position.x, p.rHand.position.y);
        g.fillStyle(p.grabL ? 0xffff00 : skin); g.fillCircle(p.lHand.position.x, p.lHand.position.y, 8);
        g.fillStyle(p.grabR ? 0xffff00 : skin); g.fillCircle(p.rHand.position.x, p.rHand.position.y, 8);
    }

    syncP2P() {
        if (conn?.open) {
            conn.send({ type: 'sync', payload: {
                bx: this.p1.body.position.x, by: this.p1.body.position.y, ba: this.p1.body.angle,
                hx: this.p1.head.position.x, hy: this.p1.head.position.y,
                lx: this.p1.lHand.position.x, ly: this.p1.lHand.position.y,
                rx: this.p1.rHand.position.x, ry: this.p1.rHand.position.y,
                gl: this.p1.grabL, gr: this.p1.grabR
            }});
        }
    }

    syncRemote(d) {
        const p = this.p2;
        this.matter.body.setPosition(p.body, {x:d.bx, y:d.by}); this.matter.body.setAngle(p.body, d.ba);
        this.matter.body.setPosition(p.head, {x:d.hx, y:d.hy});
        this.matter.body.setPosition(p.lHand, {x:d.lx, y:d.ly});
        this.matter.body.setPosition(p.rHand, {x:d.rx, y:d.ry});
        p.grabL = d.gl; p.grabR = d.gr;
    }
}

/**
 * –ó–ê–ü–£–°–ö
 */
function startOnlineGame() {
    document.getElementById('p2-box').classList.remove('empty');
    document.getElementById('menu-overlay').style.transform = 'translateY(-100%)';
    document.getElementById('hud').style.display = 'block';
    if(!window.game) window.game = new Phaser.Game({
        type: Phaser.AUTO, parent: 'game-container',
        width: Math.max(window.innerWidth, window.innerHeight), 
        height: Math.min(window.innerWidth, window.innerHeight),
        physics: { default: 'matter', matter: { gravity: { y: 1.2 }, debug: false } },
        scene: GameScene
    });
}

document.getElementById('btn-l').onpointerdown = e => { e.preventDefault(); window.gameScene.p1.grabL = !window.gameScene.p1.grabL; document.getElementById('btn-l').classList.toggle('active'); };
document.getElementById('btn-r').onpointerdown = e => { e.preventDefault(); window.gameScene.p1.grabR = !window.gameScene.p1.grabR; document.getElementById('btn-r').classList.toggle('active'); };

document.getElementById('chat-trigger').onclick = () => { document.getElementById('chat-input-box').style.display = 'block'; document.getElementById('chat-input').focus(); };
document.getElementById('chat-input').onkeydown = e => {
    if(e.key === 'Enter' && e.target.value) {
        conn?.send({ type: 'chat', msg: e.target.value });
        showChatMessage(e.target.value, 'me');
        e.target.value = ''; document.getElementById('chat-input-box').style.display = 'none';
    }
};

window.onload = () => {
    initNetwork();
    const c1 = document.getElementById('p1-canvas').getContext('2d');
    c1.fillStyle = '#5da341'; c1.fillRect(15, 30, 30, 45); c1.fillStyle = '#ffdbac'; c1.beginPath(); c1.arc(30, 20, 12, 0, 7); c1.fill();
    const c2 = document.getElementById('p2-canvas').getContext('2d');
    c2.fillStyle = '#3498db'; c2.fillRect(15, 30, 30, 45); c2.fillStyle = '#d1c4e9'; c2.beginPath(); c2.arc(30, 20, 12, 0, 7); c2.fill();
};
</script>
</body>
</html>
