<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Emotion Scanner</title>
    <!-- Подключаем библиотеку -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* --- Стилизация --- */
        body {
            margin: 0;
            background-color: #0f0f12;
            color: #00ffcc;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* Контейнер для видео и канваса */
        #video-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            background: #000;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Зеркалим как в зеркале */
            opacity: 0; /* Скрыто пока не загрузится */
            transition: opacity 1s ease;
        }

        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 2;
        }

        /* Экран загрузки */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        /* Анимация круга */
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 255, 204, 0.1);
            border-top: 4px solid #00ffcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 15px #00ffcc;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Логи */
        #logs {
            width: 90%;
            max-width: 400px;
            height: 150px;
            overflow-y: auto;
            font-size: 11px;
            text-align: left;
            border-top: 1px solid #333;
            padding-top: 10px;
            color: #00ffcc;
            font-family: monospace;
        }

        .log-line { margin: 2px 0; }
        .log-error { color: #ff4444; }
        .log-success { color: #44ff44; }

        /* Интерфейс эмоций */
        #hud {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            padding: 15px;
            border-radius: 12px;
            border-left: 3px solid #00ffcc;
            display: none;
            max-width: 200px;
        }

        .emotion-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .bar-container {
            width: 100%;
            height: 4px;
            background: #333;
            margin-bottom: 8px;
            border-radius: 2px;
        }
        
        .bar-fill {
            height: 100%;
            background: #00ffcc;
            width: 0%;
            transition: width 0.2s ease;
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <!-- Загрузка -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="status-text">Запуск системы...</div>
        <div id="logs"></div>
    </div>

    <!-- Видео -->
    <div id="video-container">
        <video id="video" autoplay muted playsinline></video>
    </div>

    <!-- Статистика -->
    <div id="hud">
        <div id="emotions-data"></div>
    </div>

    <script>
        // --- ССЫЛКА НА МОДЕЛИ (ИСПРАВЛЕНО) ---
        // Берем модели с официального репозитория библиотеки
        const MODELS_URI = 'https://justadudewhohacks.github.io/face-api.js/models';

        const video = document.getElementById('video');
        const logsEl = document.getElementById('logs');
        const hudEl = document.getElementById('hud');
        const emotionsDataEl = document.getElementById('emotions-data');
        const loadingScreen = document.getElementById('loading-screen');

        // Функция логгера
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log-line ' + (type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : '');
            div.innerText = `> ${msg}`;
            logsEl.appendChild(div);
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(msg);
        }

        async function start() {
            try {
                log("Инициализация...");

                // 1. Загрузка нейросетей
                log("Скачивание моделей нейросети...", 'info');
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URI),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URI)
                ]);
                
                log("Модели успешно загружены!", 'success');

                // 2. Доступ к камере
                log("Запрос камеры...", 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', // Фронтальная камера
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });

                video.srcObject = stream;
                log("Камера подключена.", 'success');

                // 3. Запуск видео
                video.onloadedmetadata = () => {
                    video.play();
                    log("Видеопоток активен. Анализ...", 'success');
                    
                    // Скрываем загрузку
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => loadingScreen.style.display = 'none', 500);
                        video.style.opacity = '1';
                        hudEl.style.display = 'block';
                        startDetection();
                    }, 1000);
                };

            } catch (err) {
                log("КРИТИЧЕСКАЯ ОШИБКА: " + err.message, 'error');
                if(err.message.includes("404")) {
                    log("Сервер моделей недоступен. Попробуйте VPN.", 'error');
                }
                document.querySelector('.spinner').style.borderColor = 'red';
            }
        }

        function startDetection() {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('video-container').append(canvas);
            
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // Обработка поворота экрана
            window.addEventListener('resize', () => {
                faceapi.matchDimensions(canvas, { width: video.videoWidth, height: video.videoHeight });
            });

            setInterval(async () => {
                if (video.paused || video.ended) return;

                // Детекция лиц и эмоций (TinyFaceDetector - быстрый для телефонов)
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();

                // Очистка канваса
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Изменение размеров рамок под видео
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // Рисуем рамки (если нужно, раскомментируйте)
                // faceapi.draw.drawDetections(canvas, resizedDetections);

                if (resizedDetections.length > 0) {
                    const expressions = resizedDetections[0].expressions;
                    updateUI(expressions);
                } else {
                    emotionsDataEl.innerHTML = "<div style='text-align:center; padding:10px;'>Нет лица</div>";
                }

            }, 100); // 10 раз в секунду
        }

        function updateUI(expressions) {
            const ruNames = {
                neutral: "Нейтрально",
                happy: "Счастье",
                sad: "Грусть",
                angry: "Злость",
                fearful: "Страх",
                disgusted: "Отвращение",
                surprised: "Удивление"
            };

            // Сортируем эмоции
            const sorted = Object.entries(expressions).sort((a, b) => b[1] - a[1]);
            
            let html = "";
            sorted.forEach(([key, val]) => {
                if(val > 0.05) { // Показываем, если больше 5%
                    const percent = Math.round(val * 100);
                    // Цвет полоски меняется если эмоция сильная
                    const barColor = percent > 60 ? '#00ffcc' : '#444';
                    
                    html += `
                        <div class="emotion-row">
                            <span>${ruNames[key]}</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: ${percent}%; background-color: ${barColor}"></div>
                        </div>
                    `;
                }
            });
            emotionsDataEl.innerHTML = html;
        }

        // Запуск при загрузке страницы
        window.addEventListener('load', start);

    </script>
</body>
</html>
