<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boundless Bonds | P2P Ragdoll Co-op</title>
    
    <!-- CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00e5;
            --bg-dark: #0a0a12;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background: var(--bg-dark);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        #game-container { width: 100%; height: 100%; }

        /* UI Overlays */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(10, 10, 18, 0.9);
            z-index: 10;
            transition: opacity 0.5s;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        .menu-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            text-align: center;
            width: 80%; max-width: 400px;
        }

        h1 { font-family: 'Orbitron', sans-serif; font-size: 2rem; margin-bottom: 1rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }

        .btn {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 24px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 20px var(--neon-blue); }

        .input-field {
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            color: white;
            padding: 10px;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* In-game UI */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5; display: none;
        }

        .joystick-area {
            position: absolute; bottom: 20px;
            width: 150px; height: 150px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            border: 2px dashed rgba(0, 242, 255, 0.3);
            pointer-events: auto;
        }
        #left-joy { left: 20px; }
        #right-joy { right: 20px; }

        .grab-btn {
            position: absolute; bottom: 180px;
            width: 70px; height: 70px;
            background: rgba(255, 0, 229, 0.3);
            border: 2px solid var(--neon-pink);
            border-radius: 50%;
            color: white; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        #grab-l { left: 60px; }
        #grab-r { right: 60px; }
        .grabbing { background: var(--neon-pink) !important; box-shadow: 0 0 20px var(--neon-pink); }

        /* Chat & Notifications */
        #chat-box {
            position: absolute; top: 10px; left: 10px;
            width: 250px; height: 150px;
            background: rgba(0,0,0,0.4);
            pointer-events: auto;
            display: flex; flex-direction: column;
            border-radius: 10px; font-size: 0.8rem;
        }
        #chat-messages { flex: 1; overflow-y: auto; padding: 5px; }
        #chat-input { background: transparent; border: none; border-top: 1px solid #333; color: white; padding: 5px; }

        #notification {
            position: absolute; top: 20px; right: -300px;
            width: 250px; background: var(--neon-blue);
            color: black; padding: 15px; border-radius: 10px 0 0 10px;
            transition: 0.5s; z-index: 100;
        }
    </style>
</head>
<body>

    <!-- Main Menu -->
    <div id="main-menu" class="overlay">
        <div class="menu-card">
            <h1>BOUNDLESS BONDS</h1>
            <p>Your ID: <span id="my-id" style="color:var(--neon-pink)">----</span></p>
            <input type="text" id="friend-id" class="input-field" placeholder="Enter Friend's 4-Digit ID">
            <button class="btn" onclick="connectToFriend()">Connect Friend</button>
            <div style="margin-top:20px; font-size: 0.8rem; opacity: 0.7;">
                CLAN: NEON RUNNERS [Level 12]
            </div>
            <button class="btn" style="font-size: 0.8rem; border-color: #555;" onclick="copyInviteLink()">Copy Invite Link</button>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div id="left-joy" class="joystick-area"></div>
        <div id="right-joy" class="joystick-area"></div>
        <div id="grab-l" class="grab-btn">L-GRAB</div>
        <div id="grab-r" class="grab-btn">R-GRAB</div>

        <div id="chat-box">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Type message...">
        </div>
    </div>

    <div id="notification">New Invite Received!</div>

    <div id="game-container"></div>

    <script>
        /** 
         * GLOBAL CONFIG & STATE 
         **/
        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: '#0a0a12',
            parent: 'game-container',
            physics: {
                default: 'matter',
                matter: { gravity: { y: 1 }, debug: false, enableSleeping: true }
            },
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let peer, conn;
        let myId = "";
        let player, remotePlayer;
        let cursors, scene;
        let isHost = false;
        let currentLevel = 1;
        let gameActive = false;

        const gameState = {
            p1: { x: 100, y: 100, lh: 0, rh: 0, lg: false, rg: false },
            p2: { x: 150, y: 100, lh: 0, rh: 0, lg: false, rg: false }
        };

        /**
         * NETWORKING LOGIC
         */
        function initNetwork() {
            // Generate a 4-digit ID based on random string
            const shortId = Math.floor(1000 + Math.random() * 9000).toString();
            peer = new Peer('bond-' + shortId);

            peer.on('open', (id) => {
                myId = id.split('-')[1];
                document.getElementById('my-id').innerText = myId;
                checkUrlParams();
            });

            peer.on('connection', (connection) => {
                conn = connection;
                isHost = true;
                setupConnection();
            });
        }

        function connectToFriend() {
            const id = document.getElementById('friend-id').value;
            if (id) {
                conn = peer.connect('bond-' + id);
                isHost = false;
                setupConnection();
            }
        }

        function setupConnection() {
            conn.on('open', () => {
                showNotification("Connected to Partner!");
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('hud').style.display = 'block';
                gameActive = true;
                if(isHost) {
                    conn.send({ type: 'START_LEVEL', level: currentLevel });
                }
            });

            conn.on('data', (data) => {
                if (data.type === 'SYNC') {
                    if (remotePlayer) updateRemotePlayer(data.state);
                } else if (data.type === 'CHAT') {
                    addChatMessage("Partner", data.msg);
                } else if (data.type === 'START_LEVEL') {
                    currentLevel = data.level;
                    startNewLevel();
                }
            });
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinId = urlParams.get('join');
            if (joinId) {
                document.getElementById('friend-id').value = joinId;
                setTimeout(connectToFriend, 1000);
            }
        }

        function copyInviteLink() {
            const link = window.location.origin + window.location.pathname + "?join=" + myId;
            navigator.clipboard.writeText(link);
            showNotification("Link Copied to Clipboard!");
        }

        /**
         * PHASER CORE
         */
        function preload() {
            scene = this;
            // Create base64 textures programmatically
            const graphics = this.make.graphics({ x: 0, y: 0, add: false });
            
            // Human Body Part
            graphics.fillStyle(0x00f2ff, 1);
            graphics.fillRoundedRect(0, 0, 20, 40, 10);
            graphics.generateTexture('body', 20, 40);
            
            // Head
            graphics.clear();
            graphics.fillStyle(0xffffff, 1);
            graphics.fillCircle(10, 10, 10);
            graphics.generateTexture('head', 20, 20);

            // Arm
            graphics.clear();
            graphics.fillStyle(0x00f2ff, 0.8);
            graphics.fillRoundedRect(0, 0, 8, 25, 4);
            graphics.generateTexture('arm', 8, 25);
        }

        function create() {
            this.matter.world.setBounds(0, -2000, 4000, 3000);
            
            initNetwork();
            setupChat();
            setupJoysticks();
        }

        function startNewLevel() {
            scene.matter.world.clear();
            createLevel(currentLevel);
            player = createRagdoll(200, 500, 0x00f2ff);
            remotePlayer = createRagdoll(250, 500, 0xff00e5);
        }

        function update() {
            if (!gameActive || !player) return;

            handleInput();
            syncData();
            
            // Camera follow
            if (remotePlayer) {
                const centerX = (player.body.position.x + remotePlayer.body.position.x) / 2;
                const centerY = (player.body.position.y + remotePlayer.body.position.y) / 2;
                scene.cameras.main.lerp(centerX, centerY, 0.1);
            }
        }

        /**
         * PHYSICS & RAGDOLL
         */
        function createRagdoll(x, y, color) {
            const M = scene.matter;
            
            const head = M.add.image(x, y - 50, 'head').setScale(1);
            const body = M.add.image(x, y, 'body').setScale(1);
            const lArm = M.add.image(x - 20, y, 'arm');
            const rArm = M.add.image(x + 20, y, 'arm');
            
            head.setCircle(10).setFriction(0.5);
            body.setRectangle(20, 40).setFriction(0.5);
            lArm.setRectangle(8, 25);
            rArm.setRectangle(8, 25);

            // Connect Head to Body
            M.add.constraint(head, body, 10, 0.8, { pointA: { x: 0, y: 10 }, pointB: { x: 0, y: -20 } });
            
            // Arms
            const lShoulder = M.add.constraint(body, lArm, 5, 0.8, { pointA: { x: -10, y: -15 }, pointB: { x: 0, y: -10 } });
            const rShoulder = M.add.constraint(body, rArm, 5, 0.8, { pointA: { x: 10, y: -15 }, pointB: { x: 0, y: -10 } });

            return { head, body, lArm, rArm, color, lGrab: null, rGrab: null };
        }

        /**
         * LEVEL GENERATION
         */
        function createLevel(lv) {
            const M = scene.matter;
            // Floor
            M.add.rectangle(2000, 1000, 4000, 100, { isStatic: true, render: { fillStyle: '#1a1a2e' } });

            if (lv === 1) { // Basic Climbing
                M.add.rectangle(500, 800, 50, 400, { isStatic: true, render: { fillStyle: '#333' } });
                M.add.rectangle(700, 600, 50, 400, { isStatic: true, render: { fillStyle: '#333' } });
            } else if (lv === 2) { // Platforms
                const plat = M.add.rectangle(600, 800, 200, 20, { isStatic: true, render: { fillStyle: '#00f2ff' } });
                // Animating platform logic would go here
            } else if (lv === 3) { // Water
                const water = scene.add.rectangle(1000, 800, 1000, 400, 0x0044ff, 0.3);
                // Buoyancy logic in update
            }
            
            // Goal
            const goal = M.add.rectangle(3500, 500, 100, 100, { isStatic: true, isSensor: true, render: { fillStyle: '#00ff00' } });
        }

        /**
         * INPUT & INTERACTION
         */
        let joyL = { x: 0, y: 0 }, joyR = { x: 0, y: 0 };
        let grabL = false, grabR = false;

        function setupJoysticks() {
            // Virtual Joystick Implementation (Simplified for logic)
            const handleTouch = (id, target) => {
                const el = document.getElementById(id);
                el.addEventListener('touchstart', (e) => {
                    if (id.includes('grab')) {
                        toggleGrab(id === 'grab-l' ? 'L' : 'R');
                    }
                });
                // Movement logic...
            };
            
            handleTouch('grab-l');
            handleTouch('grab-r');

            // Keyboard fallback
            cursors = scene.input.keyboard.createCursorKeys();
        }

        function toggleGrab(side) {
            const hand = side === 'L' ? player.lArm : player.rArm;
            const existing = side === 'L' ? player.lGrab : player.rGrab;

            if (existing) {
                scene.matter.world.removeConstraint(existing);
                if(side === 'L') player.lGrab = null; else player.rGrab = null;
                document.getElementById('grab-' + side.toLowerCase()).classList.remove('grabbing');
            } else {
                // Check for nearby bodies to grab
                const bodies = scene.matter.world.localWorld.bodies;
                bodies.forEach(body => {
                    if (body === hand.body || body === player.body.body) return;
                    const dist = Phaser.Math.Distance.Between(hand.x, hand.y, body.position.x, body.position.y);
                    if (dist < 40) {
                        const c = scene.matter.add.constraint(hand, body, 5, 0.9);
                        if(side === 'L') player.lGrab = c; else player.rGrab = c;
                        document.getElementById('grab-' + side.toLowerCase()).classList.add('grabbing');
                    }
                });
            }
        }

        function handleInput() {
            // Apply forces to hands based on joysticks/keys
            const force = 0.005;
            if (cursors.left.isDown) player.lArm.applyForce({ x: -force, y: -force });
            if (cursors.right.isDown) player.rArm.applyForce({ x: force, y: -force });
            
            // Simple keyboard grab toggle for testing
            scene.input.keyboard.once('keydown-Q', () => toggleGrab('L'));
            scene.input.keyboard.once('keydown-E', () => toggleGrab('R'));
        }

        /**
         * NETWORKING DATA SYNC
         */
        function syncData() {
            if (conn && conn.open) {
                const state = {
                    hx: player.head.x, hy: player.head.y,
                    bx: player.body.x, by: player.body.y, br: player.body.rotation,
                    lax: player.lArm.x, lay: player.lArm.y, lar: player.lArm.rotation,
                    rax: player.rArm.x, ray: player.rArm.y, rar: player.rArm.rotation
                };
                conn.send({ type: 'SYNC', state });
            }
        }

        function updateRemotePlayer(s) {
            remotePlayer.head.setPosition(s.hx, s.hy);
            remotePlayer.body.setPosition(s.bx, s.by);
            remotePlayer.body.setRotation(s.br);
            remotePlayer.lArm.setPosition(s.lax, s.lay);
            remotePlayer.lArm.setRotation(s.lar);
            remotePlayer.rArm.setPosition(s.rax, s.ray);
            remotePlayer.rArm.setRotation(s.rar);
        }

        /**
         * UI HELPERS
         */
        function setupChat() {
            const input = document.getElementById('chat-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value) {
                    addChatMessage("You", input.value);
                    if (conn) conn.send({ type: 'CHAT', msg: input.value });
                    input.value = "";
                }
            });
        }

        function addChatMessage(sender, msg) {
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div><b>${sender}:</b> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function showNotification(text) {
            const n = document.getElementById('notification');
            n.innerText = text;
            n.style.right = '0px';
            setTimeout(() => { n.style.right = '-300px'; }, 3000);
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            game.scale.resize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
